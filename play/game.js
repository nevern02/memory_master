"use strict";var MemoryMaster=angular.module("MemoryMaster",["ngAnimate","ui.bootstrap","ui.router"]);MemoryMaster.config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$stateProvider.state("welcome",{controller:"ModalCtrl"}).state("prepare",{controller:"ModalCtrl"}).state("playing",{controller:"PlayingCtrl",templateUrl:"playing.html"}).state("stageComplete",{controller:"ModalCtrl"}).state("gameOver",{controller:"ModalCtrl"})}]),MemoryMaster.controller("AlertCtrl",["$scope","Alert",function($scope,Alert){$scope.alerts=[],$scope.$watch(function(){return Alert.getAlerts().length},function(newValue,oldValue){newValue!==oldValue&&newValue>oldValue&&($scope.alerts=Alert.getAlerts())})}]),MemoryMaster.controller("BackgroundCtrl",["$scope",function($scope){var BACKGROUNDS=["city1.jpg","grass1.jpg","car1.jpg","buildings1.jpg","beach1.jpg","cherries1.jpg","water1.jpg","sunset1.jpg","car2.jpg","snow1.jpg","river1.jpg","sunset2.jpg","blossoms1.jpg","tree1.jpg","beach2.jpg","sunset3.jpg","street1.jpg","building1.jpg"],nextBackground=function(){var index=$scope.stage%BACKGROUNDS.length-1;return 0>index?BACKGROUNDS[BACKGROUNDS.length-1]:BACKGROUNDS[index]};$scope.$watch("stage",function(newValue,oldValue){if(newValue!==oldValue){var newBackground="images/"+nextBackground(),leaving=$scope.stage%2+1,entering=1===leaving?2:1,$leaving=$("#background"+leaving),$entering=$("#background"+entering);$entering.attr("src",newBackground),$entering.fadeIn(1e3),$leaving.fadeOut(1e3)}})}]),MemoryMaster.controller("GameCtrl",["$scope","$state","HighScores",function($scope,$state,HighScores){$scope.numberOfCards=10,$scope.stage=1,$state.go("welcome"),$scope.isBrowser=!window.location.protocol.match(/chrome-extension/),$scope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){"prepare"===toState.name&&"stageComplete"===fromState.name?($scope.stage+=1,$scope.numberOfCards+=2):"welcome"==toState.name&&($scope.stage=1,$scope.numberOfCards=10)})}]),MemoryMaster.controller("ModalCtrl",["$scope","$state","$modal",function($scope,$state,$modal){var template=$state.current.name+".html",commonOptions={templateUrl:template,backdrop:"static",controller:"ModalInstanceCtlr",scope:$scope};switch($state.current.name){case"welcome":var customOptions={size:"lg"};$modal.open($.extend({},customOptions,commonOptions)).result.then(function(){$state.go("prepare")});break;case"prepare":$modal.open(commonOptions).result.then(function(){$state.go("playing")});break;case"stageComplete":$scope.winning=!0;case"gameOver":$scope.winning=$scope.winning||!1;var customOptions={controller:"SummaryCtrl",templateUrl:"summary.html"};$modal.open($.extend({},commonOptions,customOptions)).result.then(function(){$state.go("prepare")},function(){$state.go("welcome")})}}]),MemoryMaster.controller("ModalInstanceCtlr",["$scope","$modalInstance",function($scope,$modalInstance){$scope.close=function(){$modalInstance.close()},$scope.dismiss=function(){$modalInstance.dismiss()}}]),MemoryMaster.controller("PlayingCtrl",["$scope","$rootScope","$state","$timeout","Card",function($scope,$rootScope,$state,$timeout,Card){$scope.currentPair=[],$scope.cards=Card.newSet($scope.stage,$scope.numberOfCards),$scope.enableClick=!0,$scope.reveal=function(card){$scope.enableClick&&!card.isShowing&&(card.isShowing=!0,$scope.currentPair.push(card),$scope.currentPair.length>1&&($scope.enableClick=!1,matchingCards()?($rootScope.$broadcast("cards.match",$scope.currentPair),hasWon()?$state.go("stageComplete"):($scope.currentPair=[],$scope.enableClick=!0)):($rootScope.$broadcast("cards.miss",$scope.currentPair),$timeout(function(){_.each($scope.currentPair,function(card){card.isShowing=!1,card.wasSeen=!0}),$scope.currentPair=[],$scope.enableClick=!0},1e3))))};var hasWon=function(){return!_.any($scope.cards,function(i){return!i.isShowing})},matchingCards=function(){return $scope.currentPair[0].image===$scope.currentPair[1].image}}]),MemoryMaster.controller("ScoreCtrl",["$scope","Score","Alert",function($scope,Score,Alert){$scope.score=0,$scope.multiplier=1,$scope.$watch(function(){return Score.getScore()},function(newValue,oldValue){newValue!==oldValue&&($scope.score=newValue)}),$scope.$watch(function(){return Score.getTotalMultiplier()},function(newValue,oldValue){newValue!==oldValue&&($scope.multiplier=newValue)}),$scope.$on("cards.match",function(){Score.add(10)}),$scope.$on("cards.miss",function(){Score.resetMultiplier()}),$scope.$on("$stateChangeSuccess",function(event,toState){"welcome"===toState.name&&Score.reset()}),$scope.$watch("stage",function(newValue,oldValue){newValue!==oldValue&&newValue>oldValue&&Score.setStageMultiplier($scope.stage-1)})}]),MemoryMaster.controller("SummaryCtrl",["$scope","$modalInstance","Score","HighScores","Timer",function($scope,$modalInstance,Score,HighScores,Timer){$scope.score=Score.getScore(),$scope.remainingTime=Timer.remaining(),$scope.highScore=HighScores.current(),$scope.newHighScore=!1,$scope.score>$scope.highScore&&($scope.newHighScore=!0,HighScores.save($scope.score)),$scope.close=function(){$modalInstance.close()},$scope.dismiss=function(){$modalInstance.dismiss()}}]),MemoryMaster.controller("TimerCtrl",["$scope","$state","Timer","Alert",function($scope,$state,Timer,Alert){$scope.remainingSeconds=Timer.remaining();var history=[];$scope.$on("cards.match",function(){history[0]&&(Timer.add(2),Alert.alert("+2s","green")),recordHistory(!0)}),$scope.$on("cards.miss",function(event,pair){pair[0].wasSeen&&pair[1].wasSeen&&(Timer.subtract(2),Alert.alert("-2s","red")),recordHistory(!1)}),$scope.$on("$stateChangeSuccess",function(event,toState){switch(toState.name){case"playing":Timer.start().then(function(){$state.go("gameOver")},null,function(remaining){$scope.remainingSeconds=remaining});break;case"stageComplete":case"gameOver":Timer.stop();break;case"welcome":Timer.reset(),$scope.remainingSeconds=Timer.remaining()}});var recordHistory=function(match){history.unshift(match),history.length>50&&history.pop()}}]),MemoryMaster.filter("elapsedTime",function(){var formatNumber=function(number){return 10>number?"0"+number:number.toString()};return function(seconds){var minutes=Math.floor(seconds/60),seconds=seconds%60;return formatNumber(minutes)+":"+formatNumber(seconds)}}),MemoryMaster.service("Alert",["$timeout",function($timeout){var alerts=[],count=0;this.getAlerts=function(){return alerts},this.alert=function(message,color){var newAlert={text:message,color:color,isShowing:!0},time=500*count;$timeout(function(){alerts.unshift(newAlert)},time),count+=1,$timeout(function(){count-=1,newAlert.isShowing=!1},time+350)}}]),MemoryMaster.factory("Card",["ImageList",function(ImageList){var PATTERNS=["stairs","microbial","horizontal-stripes","rombes","arrows","zig-zag","weave","upholstery","stary","marrakesh","bokeh","carbon","vertical-stripes","carbon-fibre","hearts","argyle","steps","waves","cross","yin-yang","stars","brady-bunch","shippo","bricks","seigaiha","japanese-cube","polka-dot","houndstooth","checkerboard","diagonal-checkerboard","tartan","madras","lined-paper","blueprint-grid","tablecloth","diagonal-stripes","cicada-stripes"],cardWidth=function(stage){return Math.max(9.5-.5*stage,2)+"em"},cardHeight=function(stage){return Math.max(12.5-.5*stage,2)+"em"},fontSize=function(stage){return Math.max(6.5-.5*stage,1)+"em"},cardPattern=function(stage){var index=stage%PATTERNS.length-1;return 0>index?PATTERNS[PATTERNS.length-1]:PATTERNS[index]},Card=function(icon){this.isShowing=!1,this.wasSeen=!1,this.image=icon.image,this.color=icon.color};return Card.newSet=function(stage,numberOfCards){var imageList=new ImageList(numberOfCards),width=cardWidth(stage),height=cardHeight(stage),font=fontSize(stage),pattern=cardPattern(stage);return _.map(imageList.images,function(image){var card=new Card(image);return card.width=width,card.height=height,card.fontSize=font,card.pattern=pattern,card})},Card}]),MemoryMaster.service("HighScores",function(){var highScore=0,isChromeEnabled=chrome&&chrome.storage;if(isChromeEnabled)chrome.storage.sync.get("highScore",function(data){data.highScore&&(highScore=data.highScore)});else{var cookie=document.cookie.replace(/(?:(?:^|.*;\s*)highScore\s*\=\s*([^;]*).*$)|^.*$/,"$1");cookie.length>0&&(highScore=parseInt(cookie))}this.current=function(){return highScore},this.save=function(score){highScore=score,isChromeEnabled?chrome.storage.sync.set({highScore:score},null):document.cookie="highScore="+highScore}}),MemoryMaster.factory("ImageList",function(){var COLORS=["red","green","blue","teal","orange","purple","brown","darkcyan","olive","tan","violet"],IMAGES=["fa-adjust","fa-anchor","fa-archive","fa-arrows","fa-arrows-h","fa-arrows-v","fa-asterisk","fa-automobile","fa-ban","fa-bank","fa-barcode","fa-bars","fa-beer","fa-bell","fa-bell-o","fa-bolt","fa-bomb","fa-book","fa-bookmark","fa-bookmark-o","fa-briefcase","fa-bug","fa-building","fa-building-o","fa-bullhorn","fa-bullseye","fa-cab","fa-calendar","fa-calendar-o","fa-camera","fa-camera-retro","fa-car","fa-caret-square-o-down","fa-caret-square-o-left","fa-caret-square-o-right","fa-caret-square-o-up","fa-certificate","fa-check","fa-check-circle","fa-check-circle-o","fa-check-square","fa-check-square-o","fa-child","fa-circle","fa-circle-o","fa-circle-o-notch","fa-circle-thin","fa-clock-o","fa-cloud","fa-cloud-download","fa-cloud-upload","fa-code","fa-code-fork","fa-coffee","fa-bar-chart-o","fa-cog","fa-cogs","fa-comment","fa-comment-o","fa-comments"],ImageList=function(count){var images=_.shuffle(IMAGES).slice(0,count/2),imageColorMap=_.map(images,function(image){var color=_.shuffle(COLORS).shift();return{image:image,color:color}});this.images=_.shuffle(imageColorMap.concat(_.clone(imageColorMap)))};return ImageList}),MemoryMaster.service("Score",["Alert",function(Alert){var score=0,multiplier=1,stageMultiplier=0,history=[],recordHistory=function(match){history.unshift(match),history.length>50&&history.pop()},alert=function(){multiplier>1&&Alert.alert("x"+(multiplier+stageMultiplier),"teal")};this.getScore=function(){return score},this.reset=function(){multiplier=1,stageMultiplier=0,score=0,history=[]},this.add=function(points){score+=points*(multiplier+stageMultiplier),history[0]&&(multiplier+=1,alert()),recordHistory(!0)},this.getTotalMultiplier=function(){return multiplier+stageMultiplier},this.resetMultiplier=function(){multiplier=1,recordHistory(!1)},this.setStageMultiplier=function(value){stageMultiplier=value}}]),MemoryMaster.service("Timer",["$interval","$q",function($interval,$q){var startingSeconds=300,currentSeconds=startingSeconds,promise=null,deferred=null,tick=function(){currentSeconds-=1,deferred.notify(currentSeconds),0===currentSeconds&&(stop(),deferred.resolve())};this.remaining=function(){return currentSeconds},this.start=function(){return deferred=$q.defer(),promise=$interval(function(){tick()},1e3),deferred.promise},this.stop=function(){$interval.cancel(promise)},this.reset=function(){currentSeconds=startingSeconds},this.subtract=function(amount){currentSeconds-=amount},this.add=function(amount){currentSeconds+=amount}}]);